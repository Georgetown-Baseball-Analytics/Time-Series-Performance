library(tidyverse)
library(rio)
library(janitor)
import_data <- function() {
d <- read_csv("../data/data_tonas.csv")
d <- clean_names(d)
return(d)
}
clean_inning <- function(d) {
if (any(str_length(d$inning) < 2) | any(str_length(d$inning) > 3)) {
print("Check inning variable - string length less than 2 or greater than 3")
}
d <- d %>%
mutate(
top_or_bottom_letter = str_remove_all(inning, "[0-9]"),
top_of_frame = if_else(top_or_bottom_letter == "T", 1, 0),
inning_num = str_remove_all(inning, "[^0-9]")
)
}
clean_count <- function(d) {
d <- d %>%
separate("count", into = c("balls", "strikes"), sep = "-", convert = TRUE)
return(d)
}
add_outing_id <- function(d) {
d <- d %>%
mutate(outing_id = 1)
cur_outing <- d$notes[1]
cur_outing_num <- 1
for (i in seq_along(d$notes)) {
if (d$notes[i] == cur_outing) {
d$outing_id[i] <- cur_outing_num
}
else {
cur_outing_num <- cur_outing_num + 1
d$outing_id[i] <- cur_outing_num
cur_outing <- d$notes[i]
}
}
return(d)
# does not work if pitcher pitches in multiple consecutive games against the same opponent
}
add_pa_id <- function(d) {
add_pa_id_by_outing <- function(df) {
df <- df %>%
mutate(pa_id = 1)
cur_pa <- df$title[1]
cur_pa_num <- 1
for (i in seq_along(df$title)) {
if (df$title[i] == cur_pa) {
df$pa_id[i] <- cur_pa_num
}
else {
cur_pa_num <- cur_pa_num + 1
df$pa_id[i] <- cur_pa_num
cur_pa <- df$title[i]
}
}
return(df)
}
d <- d %>%
group_by(outing_id) %>%
nest()
d$data <- map(d$data, add_pa_id_by_outing)
d <- d %>%
unnest(cols = data)
return(d)
}
clean_result <- function(d) {
d <- d %>%
mutate(
non_bip_result_clean = str_remove_all(non_bip_result, ","),
non_bip_result = if_else(non_bip_result_clean == "", NA_character_, non_bip_result_clean)
) %>%
select(-non_bip_result_clean)
return(d)
}
clean_data_pipeline <- function(d) {
d <- d %>%
clean_names() %>%
clean_inning() %>%
clean_count() %>%
add_outing_id() %>%
add_pa_id() %>%
clean_result()
return(d)
}
export_data <- function(d) {
rio::export(d, "../data/tonas_clean.csv")
}
d <- import_data() %>% clean_data_pipeline() %>% export_data()
#source("Kishor import.R")
library(tidyverse)
d <- read_csv("../data/tonas_clean.csv")
d <- d %>%
mutate(
strike = case_when(
pitch_result %in% c("Strike Swinging", "Strike Taken", "Foul", "BIP") ~ 1,
TRUE ~ 0
)) %>%
group_by(outing_id) %>%
mutate(
pitch_num_by_outing = row_number()) %>%
ungroup() %>%
mutate(
pitch_group_by_ten = (pitch_num_by_outing %/% 10) + 1,
pg_b = pitch_group_by_ten * 10,
pg_a = pg_b - 9,
pitch_group = str_c(pg_a, pg_b, sep = "-")
)
dd <- d %>%
group_by(pitch_group) %>%
summarize(
strike_pct = mean(strike),
count = n(),
)
pitcher <- unique(d$pitcher)
ggplot(dd) +
geom_point(aes(x = pitch_group, y = strike_pct)) +
geom_line(aes(x = pitch_group, y = strike_pct, group = 1)) +
scale_y_continuous(labels = scales::percent) +
labs(title = paste(pitcher, "Strike % by Pitch Count"), y = "Strike Percentage", x = "Pitch Number") +
theme_bw()
d <- d %>%
mutate(
strikeout = case_when(
non_bip_result %in% c("Strikeout,") ~ 1,
TRUE ~ 0
)) %>%
mutate(
walk = case_when(
non_bip_result %in% c("Walk,") ~ 1,
TRUE ~ 0
))
dk <- d %>%
group_by(pitch_group) %>%
summarize(
Outcome = sum(strikeout),
Name = "Strikeout"
)
dbb <- d %>%
group_by(pitch_group) %>%
summarize(
Outcome = sum(walk),
Name = "Walk"
)
ddd <- rbind(dk, dbb)
ggplot(ddd, aes(x = pitch_group, y = Outcome, group = Name, color = Name)) +
geom_point() +
geom_line()
View(dbb)
View(d)
d <- d %>%
mutate(
strikeout = case_when(
non_bip_result %in% c("Strikeout,") ~ 1,
TRUE ~ 0
)) %>%
mutate(
walk = case_when(
non_bip_result %in% c("Walk,") ~ 1,
TRUE ~ 0
))
dk <- d %>%
group_by(pitch_group) %>%
summarize(
Outcome = sum(strikeout),
Name = "strikeout"
)
dbb <- d %>%
group_by(pitch_group) %>%
summarize(
Outcome = sum(walk),
Name = "walk"
)
ddd <- rbind(dk, dbb)
ggplot(ddd, aes(x = pitch_group, y = Outcome, group = Name, color = Name)) +
geom_point() +
geom_line()
View(dbb)
d <- d %>%
mutate(
strikeout = case_when(
non_bip_result %in% c("strikeout,") ~ 1,
TRUE ~ 0
)) %>%
mutate(
walk = case_when(
non_bip_result %in% c("walk,") ~ 1,
TRUE ~ 0
))
dk <- d %>%
group_by(pitch_group) %>%
summarize(
Outcome = sum(strikeout),
Name = "strikeout"
)
dbb <- d %>%
group_by(pitch_group) %>%
summarize(
Outcome = sum(walk),
Name = "walk"
)
ddd <- rbind(dk, dbb)
ggplot(ddd, aes(x = pitch_group, y = Outcome, group = Name, color = Name)) +
geom_point() +
geom_line()
View(dbb)
View(d)
d <- d %>%
mutate(
strikeout = case_when(
non_bip_result %in% c("strikeout,") ~ 1,
TRUE ~ 0
)) %>%
mutate(
walk = case_when(
non_bip_result %in% c("walk,") ~ 1,
TRUE ~ 0
))
View(d)
d <- d %>%
mutate(
strikeout = case_when(
non_bip_result %in% c("strikeout") ~ 1,
TRUE ~ 0
)) %>%
mutate(
walk = case_when(
non_bip_result %in% c("walk") ~ 1,
TRUE ~ 0
))
dk <- d %>%
group_by(pitch_group) %>%
summarize(
Outcome = sum(strikeout),
Name = "strikeout"
)
dbb <- d %>%
group_by(pitch_group) %>%
summarize(
Outcome = sum(walk),
Name = "walk"
)
ddd <- rbind(dk, dbb)
ggplot(ddd, aes(x = pitch_group, y = Outcome, group = Name, color = Name)) +
geom_point() +
geom_line()
View(d)
d <- d %>%
mutate(
strikeout = case_when(
non_bip_result %in% c("Strikeout") ~ 1,
TRUE ~ 0
)) %>%
mutate(
walk = case_when(
non_bip_result %in% c("Walk") ~ 1,
TRUE ~ 0
))
dk <- d %>%
group_by(pitch_group) %>%
summarize(
Outcome = sum(strikeout),
Name = "strikeout"
)
dbb <- d %>%
group_by(pitch_group) %>%
summarize(
Outcome = sum(walk),
Name = "walk"
)
ddd <- rbind(dk, dbb)
ggplot(ddd, aes(x = pitch_group, y = Outcome, group = Name, color = Name)) +
geom_point() +
geom_line()
d_ba <- d %>%
group_by(outing_id, pa_id) %>%
summarize(no_result = sum(!is.na(bip_result)) + sum(!is.na(non_bip_result)))
assertthat::assert_that(all(d_ba$no_result == 1))
d_ba <- d %>%
filter(!is.na(bip_result) | !is.na(non_bip_result)) %>%
group_by(pitch_group, outing_id, pa_id) %>%
summarize(
pa_outcome = if_else(!is.na(bip_result), bip_result, non_bip_result)
) %>%
mutate( # this is what changes for slugging and OBP
ba_bin = case_when(
pa_outcome %in% c(
"Single",
"Double",
"Home Run"
) ~ 1,
pa_outcome %in% c(
"Flyout",
"Strikeout",
"Groundout",
"Lineout"
) ~ 0,
pa_outcome == "Walk" ~ NA_real_,
TRUE ~ NA_real_
# do this for all
)
)
d_ba_collapsed <- d_ba %>%
group_by(pitch_group) %>%
summarize(
mean_ba = mean(ba_bin, na.rm = T)
)
View(d_ba)
View(d_ba)
View(d_ba_collapsed)
unique(pa_outcome)
unique(d_ba$pa_outcome)
d_slg <- d %>%
group_by(outing_id, pa_id) %>%
summarize(no_result = sum(!is.na(bip_result)) + sum(!is.na(non_bip_result)))
assertthat::assert_that(all(d_ba$no_result == 1))
d_slg <- d %>%
filter(!is.na(bip_result) | !is.na(non_bip_result)) %>%
group_by(pitch_group, outing_id, pa_id) %>%
summarize(
pa_outcome = if_else(!is.na(bip_result), bip_result, non_bip_result)
) %>%
mutate( # this is what changes for slugging and OBP
slg_bin = case_when(
pa_outcome %in% c("Single") ~ 1,
pa_outcome %in% c("Double") ~ 2,
pa_outcome %in% c("Triple") ~ 3,
pa_outcome %in% c("Home Run") ~ 4,
pa_outcome %in% "Walk" ~ NA_real_,
TRUE ~ NA_real_
# do this for all
)
)
d_slg_collapsed <- d_slg %>%
group_by(pitch_group) %>%
summarize(
mean_ba = mean(slg_bin, na.rm = T)
)
View(d_slg_collapsed)
